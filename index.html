<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stats</title>
    <!-- Import Fira Code font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Transparent background for OBS */
        body {
            background-color: rgba(0, 0, 0, 0);
            color: #000000; /* Black text */
            font-family: 'Fira Code', 'Arial', monospace;
            font-weight: 700;
            margin: 0;
            padding: 10px;
        }
        
        /* Container for title and cards */
        .dashboard-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center everything */
            gap: 10px;
        }
        
        /* Title styling (TODAY or PAST) */
        .time-period-title {
            font-size: 32px;
            font-weight: 700;
            color: #FFFFFF; /* White */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9);
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: 2px;
            text-align: center; /* Center the text */
        }
        
        .stats-container {
            display: flex;
            flex-direction: column; 
            align-items: center; /* Center cards */
            gap: 12px;
        }
        
        /* Square white card with black shadow */
        .stat-card {
            background-color: #FFFFFF; /* White background */
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            width: 80px; /* Fixed width */
            height: 70px; /* Fixed height = square */
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.8); /* Black shadow */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Vertically center content */
            align-items: center; /* Horizontally center content */
            gap: 8px;
        }
        
        .card-label {
            font-size: 16px;
            text-transform: uppercase;
            color: #000000; /* Black label */
            display: block;
            font-weight: 700;
            line-height: 1.2;
            word-wrap: break-word; /* Wrap long words */
            width: 100%; /* Fill container width */
            max-width: 100%;
        }
        
        .card-value {
            font-size: 48px;
            color: #000000; /* Black value */
            display: block;
            line-height: 1;
            font-weight: 700;
        }
        
        #error-message {
            color: #FF0000;
            font-size: 14px;
            display: none;
            margin-top: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #000000;
            padding: 8px;
            border-radius: 4px;
            border: 2px solid #FF0000;
        }
        
        /* ESPN-style Stat Ticker */
        .ticker-wrapper {
            position: fixed; /* Fixed to viewport */
            bottom: 0; /* Stick to bottom of screen */
            left: 0;
            right: 0;
            width: 100vw; /* Full viewport width */
            background-color: #000000; 
            border-radius: 4px;
            padding: 10px 0;
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.8); /* Shadow on top only */
            z-index: 1000; /* Ensure it's on top */
        }
        
        .ticker-container {
            display: flex;
            white-space: nowrap;
            animation: scroll-left 60s linear infinite;
        }
        
        @keyframes scroll-left {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }
        
        .ticker-item {
            display: inline-block;
            padding: 0 30px;
            font-size: 16px;
            color: #FFFFFF;
            font-weight: 400;
        }
        
        .ticker-separator {
            display: inline-block;
            color: #FFD700; /* Gold separator */
            font-weight: 700;
            padding: 0 10px;
        }

        /* Responsive font sizing for different resolutions */
        @media (min-width: 1920px) {
            /* 1080p and above */
            .ticker-item {
                font-size: 20px;
                padding: 0 50px;
            }
        }
        
        @media (min-width: 2560px) {
            /* 2K (1440p) and above */
            .ticker-item {
                font-size: 24px;
                padding: 0 60px;
            }
        }
        
        @media (min-width: 3840px) {
            /* 4K and above */
            .ticker-item {
                font-size: 32px;
                padding: 0 80px;
            }
            .ticker-wrapper {
                padding: 15px 0;
            }
        }
        
        @media (min-width: 7680px) {
            /* 8K */
            .ticker-item {
                font-size: 48px;
                padding: 0 120px;
            }
            .ticker-wrapper {
                padding: 20px 0;
            }
        }
    </style>
</head>
<body>
    
    <!-- Dashboard wrapper -->
    <div class="dashboard-wrapper">
        <!-- Title (TODAY or PAST) -->
        <div class="time-period-title" id="time-period-title">...</div>
        
        <!-- Container for dynamic stat cards -->
        <div class="stats-container" id="stats-container">
            <!-- Cards will be dynamically generated here -->
        </div>
        
        <!-- ESPN-style stat ticker -->
        <div class="ticker-wrapper" id="ticker-wrapper" style="display: none;">
            <div class="ticker-container" id="ticker-container">
                <!-- Facts will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <div id="error-message"></div>

    <script>
        // --- CONFIGURATION ---
        // 1. Set your Render API URL (base path only)
        // Example: const API_URL = "https://yourdomain.com/api/get_live_dashboard";
        // Example for local testing: Uncomment the line below
        // const API_URL = "http://127.0.0.1:5000/api/get_live_dashboard";
        // cont TICKER_API_URL = "http://127.0.0.1:5000/api/get_stat_ticker";
        // Production example:
        const API_URL = "https://video-game-stats-api.onrender.com/api/get_live_dashboard";
        const TICKER_API_URL = "https://video-game-stats-api.onrender.com/api/get_stat_ticker";
        
        // 2. Set polling interval (in milliseconds)
        const REFRESH_INTERVAL_MS = 5000; // 5 seconds
        const TICKER_REFRESH_INTERVAL_MS = 30000; // 30 seconds (ticker updates less frequently)
        // ---------------------

        let fullApiUrl = ''; // Will be built dynamically
        let fullTickerApiUrl = '';
        let tickerFacts = [];

        // Function to dynamically build the stats UI
        function buildUIAndApiUrl() {
            // Check if API_URL is still the placeholder
            if (API_URL.includes("your-flask-api.onrender.com")) {
                showError("ERROR: API_URL is a placeholder. Edit dashboard.html and set your API URL.");
                return false;
            }

            const params = new URLSearchParams(window.location.search);
            const container = document.getElementById('stats-container');
            container.innerHTML = ''; // Clear old cards
            
            const key = params.get('key');
            const tz = params.get('tz') || 'UTC';

            if (!key) {
                showError("Error: URL is missing key parameter.");
                return false;
            }

            // Build API URLs
            fullApiUrl = `${API_URL}?key=${key}&tz=${tz}`;
            fullTickerApiUrl = `${TICKER_API_URL}?key=${key}&tz=${tz}`;

            console.log("üîó Dashboard API URL:", fullApiUrl);
            console.log("üîó Ticker API URL:", fullTickerApiUrl);

            // Create placeholder cards (will be populated by API response)
            for (let i = 1; i <= 3; i++) {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.id = `stat${i}-card`;
                card.style.display = 'none'; // Hidden until data arrives
                
                const label = document.createElement('span');
                label.className = 'card-label';
                label.id = `stat${i}-label`;
                label.textContent = '...';
                
                const value = document.createElement('span');
                value.className = 'card-value';
                value.id = `stat${i}-value`;
                value.textContent = '...';
                
                card.appendChild(label);
                card.appendChild(value);
                container.appendChild(card);
            }

            return true;
        }

        // Function to update the stat values on the page
        function updateStats(data) {
            // Update the time period title (TODAY or PAST)
            const titleElement = document.getElementById('time-period-title');
            if (data.time_period) {
                titleElement.textContent = data.time_period;
                titleElement.style.display = 'block';
            }
            
            // Update stat cards
            for (let i = 1; i <= 3; i++) {
                const statKey = `stat${i}`;
                if (data[statKey]) {
                    const card = document.getElementById(`${statKey}-card`);
                    const label = document.getElementById(`${statKey}-label`);
                    const value = document.getElementById(`${statKey}-value`);
                    
                    if (card && label && value) {
                        card.style.display = 'block'; // Show card
                        label.textContent = data[statKey].label || '---';
                        value.textContent = data[statKey].value === 0 ? 0 : (data[statKey].value || '---');
                    }
                } else {
                    // Hide cards that don't have data
                    const card = document.getElementById(`${statKey}-card`);
                    if (card) {
                        card.style.display = 'none';
                    }
                }
            }
        }

        // Function to show errors
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            if (message) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            } else {
                errorEl.textContent = '';
                errorEl.style.display = 'none';
            }
        }

        // Function to fetch data from the API
        async function fetchStats() {
            if (!fullApiUrl) {
                console.log("API URL not built yet.");
                return;
            }

            console.log("Fetching live stats from:", fullApiUrl);
            try {
                const response = await fetch(fullApiUrl, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    let errorMsg = `HTTP Error: ${response.status} ${response.statusText}`;
                    try {
                        const errData = await response.json();
                        errorMsg = `API Error: ${errData.error || 'Unknown'}`;
                    } catch (e) {
                        errorMsg = `HTTP Error: ${response.status}. Server returned non-JSON response.`;
                    }
                    console.error(errorMsg);
                    showError(errorMsg);
                    return;
                }
                
                const data = await response.json();
                updateStats(data);
                showError(""); // Clear error on success

            } catch (error) {
                console.error("Failed to fetch stats:", error);
                showError("Fetch Error: Failed to connect. Is the API running and CORS enabled?");
            }
        }

        // Function to fetch ticker data
        async function fetchTickerData() {
            if (!fullTickerApiUrl) {
                console.log("Ticker API URL not built yet.");
                return;
            }

            console.log("Fetching ticker data from:", fullTickerApiUrl);
            try {
                const response = await fetch(fullTickerApiUrl, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    console.error(`Ticker API Error: ${response.status}`);
                    return;
                }
                
                const data = await response.json();
                if (data.facts && data.facts.length > 0) {
                    updateTicker(data.facts);
                }

            } catch (error) {
                console.error("Failed to fetch ticker data:", error);
            }
        }

        // Function to update the ticker
        function updateTicker(facts) {
            const tickerContainer = document.getElementById('ticker-container');
            const tickerWrapper = document.getElementById('ticker-wrapper');
            
            if (facts.length === 0) {
                tickerWrapper.style.display = 'none';
                return;
            }
            
            // Shuffle facts for randomization
            const shuffledFacts = facts.sort(() => Math.random() - 0.5);
            
            // Build ticker HTML
            let tickerHTML = '';
            shuffledFacts.forEach((fact, index) => {
                tickerHTML += `<span class="ticker-item">${fact}</span>`;
                if (index < shuffledFacts.length - 1) {
                    tickerHTML += '<span class="ticker-separator">‚óè</span>';
                }
            });
            
            // Duplicate content for seamless loop
            tickerContainer.innerHTML = tickerHTML + tickerHTML;
            tickerWrapper.style.display = 'block';
        }

        // --- Run the functions ---
        if (buildUIAndApiUrl()) {
            fetchStats();
            fetchTickerData(); // Initial ticker load
            setInterval(fetchStats, REFRESH_INTERVAL_MS);
            setInterval(fetchTickerData, TICKER_REFRESH_INTERVAL_MS); // Ticker updates every 30 seconds
        }
    </script>
</body>
</html>